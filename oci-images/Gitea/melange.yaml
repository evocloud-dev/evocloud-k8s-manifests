# SPDX-FileCopyrightText: 2025 EvoCloud, Inc.
# SPDX-License-Identifier: MPL-2.0

package:
  name: gitea
  version: 1.25.2
  epoch: 0
  description: "Gitea: A painless self-hosted Git service"
  target-architecture:
    - x86_64
    #- aarch64
  url: "https://gitea.com/"
  copyright:
    - attestation: |
        Created by the EvoCloud Engineering Team. 
        Copyright (C) 2025 EvoCloud, Inc.
      license: MPL-2.0

environment:
  contents:
    repositories:
      - https://packages.wolfi.dev/os
    keyring:
      - https://packages.wolfi.dev/os/wolfi-signing.rsa.pub
    packages:
      - ca-certificates-bundle
      - go
      - nodejs
      - pnpm
      - yarn

pipeline:
  - name: "Prepare extraction directory"
    runs: |
      mkdir -p gitea

  - name: "Download Source"
    uses: fetch
    with:
      uri: https://github.com/go-gitea/gitea/archive/refs/tags/v${{package.version}}.tar.gz
      expected-sha512: "b946844408bfbf695961604195af12876422f9f275c0cf0043319ff2b8a1a8a633a286010324bae8ee9764147b52989dfe230bcaac0856d7c03cb7643bb1bede"
      directory: gitea
      strip-components: 1
      delete: true

  - name: "Build Gitea Binary"
    uses: go/build
    with:
      modroot: gitea
      packages: .
      ldflags: -s -X "main.Version=${{package.version}}" 
              
      output: gitea


  - name: "Build cmd tool binary"
    uses: go/build
    with:
      modroot: gitea
      packages: ./cmd
      ldflags: -s  
      output: gitea-cmd


  - name: "Strip Binary"
    uses: strip

  - name: "Clean Up"
    runs: |
      rm -rf gitea


